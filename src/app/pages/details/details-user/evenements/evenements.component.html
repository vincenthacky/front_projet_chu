<nz-spin [nzSpinning]="loading" nzTip="Chargement des événements...">
  <section class="content">
    <div class="container-fluid">
      <h6 class="evenements-title">
        <i class="fas fa-map-marked-alt"></i>
        Suivi du Projet & Avancement des Terrains
      </h6>

      <!-- Error Message -->
      <div *ngIf="error && !loading" class="error-container">
        <div class="error-message">
          <i class="fas fa-exclamation-triangle"></i>
          <span>{{ error }}</span>
        </div>
        <button class="retry-btn" (click)="chargerMesEvenements()">
          <i class="fas fa-redo"></i> Réessayer
        </button>
      </div>

      <!-- Content -->
      <div *ngIf="!loading && !error">
        <!-- Section Mes Souscriptions -->
        <div class="souscription-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-user-check"></i> Mes Souscriptions
            </div>
            <div class="section-subtitle">Suivi personnalisé de vos terrains</div>
          </div>
          
          <!-- Timeline des événements -->
          <div class="timeline" *ngIf="evenementsSouscription.length > 0">
            <!-- Label de date pour les souscriptions -->
            <div class="time-label blue">
              <span>{{ getDateRangeLabel(evenementsSouscription) }} - Mes Projets</span>
            </div>
            
            <!-- Boucle sur les événements de souscription paginés -->
            <div *ngFor="let event of getPaginatedEvents(); let i = index">
              <i class="fas" 
                 [ngClass]="getEventIcon(event.type_evenement)" 
                 [class]="getEventColor(event.type_evenement, getEventStatusDynamic(event).percentage)"
                 [style.background-color]="event.type_evenement.couleur_affichage"></i>
              
              <div class="timeline-item">
                <span class="time">
                  <i class="fas fa-clock"></i> 
                  <span class="status-text" 
                        [style.color]="getEventStatusDynamic(event).color"
                        [style.background-color]="getEventStatusDynamic(event).bgColor"
                        [style.border-color]="getEventStatusDynamic(event).color">
                    {{ getEventStatusDynamic(event).status }}
                  </span>
                </span>
                
                <h3 class="timeline-header">
                  <a href="#" (click)="onEventClick(event)">{{ event.titre }}</a>
                  <span *ngIf="event.lieu"> - {{ event.lieu }}</span>
                </h3>
                
                <div class="timeline-body">
                  {{ event.description }}
                  <br><br>
                  
                  <!-- AFFICHAGE DES MÉDIAS DANS LA TIMELINE -->
                  <div class="event-medias" *ngIf="getEventImages(event).length > 0 || getEventVideos(event).length > 0 || getEventPdfs(event).length > 0">
                    <div class="medias-container">
                      
                      <!-- IMAGES -->
                      <div *ngFor="let doc of getEventImages(event); let i = index" class="image-wrapper">
                        <img 
                          [src]="getDocumentUrl(doc)"
                          [alt]="event.titre + ' - Image ' + (i + 1)"
                          class="event-image"
                          (click)="openImageModal(getDocumentUrl(doc), event.titre)"
                          (error)="onImageError($event)"
                          style="max-width: 200px; height: auto; cursor: pointer; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                      </div>
                      
                      <!-- VIDÉOS -->
                      <div *ngFor="let doc of getEventVideos(event); let i = index" class="event-video-container" style="margin: 10px 0;">
                        <video 
                          [src]="getDocumentUrl(doc)"
                          class="event-video"
                          controls
                          preload="metadata"
                          (error)="onVideoError($event)"
                          style="max-width: 300px; height: auto; border-radius: 8px;">
                          Votre navigateur ne supporte pas la lecture vidéo.
                        </video>
                        <div class="video-label" style="font-size: 12px; color: #666; margin-top: 5px;">
                          <i class="fas fa-play-circle"></i>
                          {{ doc.nom_original }}
                        </div>
                      </div>

                      <!-- PDFs -->
                      <div *ngFor="let doc of getEventPdfs(event); let i = index" class="pdf-wrapper" style="margin: 10px 0;">
                        <div class="pdf-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
                          <div class="pdf-icon" style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-file-pdf" style="font-size: 24px; color: #dc3545; margin-right: 10px;"></i>
                            <div>
                              <div style="font-weight: 600;">{{ doc.nom_original }}</div>
                              <div style="font-size: 12px; color: #666;">Document PDF</div>
                            </div>
                          </div>
                          
                          <div class="pdf-actions" style="display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-primary" (click)="openPdfModal(getDocumentUrl(doc), event.titre)">
                              <i class="fas fa-eye"></i> Visualiser
                            </button>
                            <button class="btn btn-sm btn-outline-primary" (click)="openPdfInNewTab(getDocumentUrl(doc))">
                              <i class="fas fa-external-link-alt"></i> Ouvrir
                            </button>
                          </div>
                        </div>
                      </div>
                      
                    </div>
                  </div>
                  
                  <!-- MESSAGE SI AUCUN MÉDIA -->
                  <div *ngIf="hasDocuments(event) && getEventImages(event).length === 0 && getEventVideos(event).length === 0 && getEventPdfs(event).length === 0" 
                       class="no-media-message" style="background: #fff3cd; padding: 10px; border: 1px solid #ffeaa7; border-radius: 5px; margin: 10px 0;">
                    <i class="fas fa-file-alt"></i>
                    Documents disponibles ({{ getDocumentsLength(event) }})
                  </div>
                  
                  <!-- MESSAGE SI AUCUN DOCUMENT -->
                  <div *ngIf="!hasDocuments(event)" 
                       class="no-documents-message" style="background: #ffebee; padding: 10px; border: 1px solid #ffcdd2; border-radius: 5px; margin: 10px 0;">
                    <i class="fas fa-info-circle"></i>
                    Aucun document associé à cet événement
                  </div>
                </div>

                <div class="evenement-info">
                  <span class="tag" [ngClass]="getTypeClass(event.type_evenement.libelle_type_evenement)">
                    {{ event.type_evenement.libelle_type_evenement }}
                  </span>
                  <span class="tag etape" *ngIf="event.etape_actuelle">{{ event.etape_actuelle }}</span>
                  <span class="tag">{{ event.lieu }}</span>
                  <span class="tag status-tag" 
                        [style.background-color]="getEventStatusDynamic(event).bgColor"
                        [style.color]="getEventStatusDynamic(event).color"
                        [style.border-color]="getEventStatusDynamic(event).color">
                    {{ getEventStatusDynamic(event).status }}
                  </span>
                </div>

                <div class="evenement-dates">
                  <strong>Date :</strong> {{ event.date_debut_evenement | date:'dd/MM/yyyy' }}
                  <span *ngIf="event.date_debut_evenement !== event.date_fin_evenement">
                    - {{ event.date_fin_evenement | date:'dd/MM/yyyy' }}
                  </span>
                </div>

                <!-- Info terrain si disponible -->
                <div class="terrain-info" *ngIf="event.souscription && event.souscription.terrain">
                  <strong>Terrain:</strong> {{ event.souscription.terrain.libelle }}
                  ({{ event.souscription.terrain.superficie }}m²)
                  - {{ event.souscription.terrain.localisation }}
                </div>

                <div class="progress-section">
                  <div class="progress-label">
                    {{ getProgressLabel(event.type_evenement.libelle_type_evenement) }}
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" 
                         [style.width.%]="getEventStatusDynamic(event).percentage"
                         [style.background]="getProgressGradient(0, event)"></div>
                  </div>
                  <div class="progress-text" [style.color]="getEventStatusDynamic(event).color">
                    {{ getEventStatusDynamic(event).percentage === 100 ? 'Terminé avec succès ✓' : 
                       getEventStatusDynamic(event).percentage === 0 ? 'À venir' : 
                       getEventStatusDynamic(event).percentage + '% en cours' }}
                  </div>
                </div>

                <!-- Coûts si disponibles -->
                <div class="couts-info" *ngIf="event.cout_estime || event.cout_reel">
                  <div *ngIf="event.cout_estime">
                    <strong>Coût estimé:</strong> {{ formatCurrency(event.cout_estime) }}
                  </div>
                  <div *ngIf="event.cout_reel">
                    <strong>Coût réel:</strong> {{ formatCurrency(event.cout_reel) }}
                  </div>
                </div>

                <div class="timeline-footer">
                  <p *ngIf="hasDocuments(event)">
                    Documents ({{ getDocumentsLength(event) }})
                  </p>
                </div>
              </div>
            </div>

            <!-- Indicateur de fin -->
            <div>
              <i class="fas fa-clock bg-gray"></i>
            </div>
          </div>

          <!-- Message si aucun événement trouvé -->
          <nz-empty 
            *ngIf="evenementsSouscription.length === 0 && !loading && !error"
            nzNotFoundImage="https://gw.alipayobjects.com/zos/antfincdn/ZHrcdLPrvN/empty.svg"
            nzNotFoundContent="Aucun événement trouvé">
          </nz-empty>

          <!-- Pagination -->
          <div class="pagination-container" *ngIf="evenementsSouscription.length > 0">
            <!-- <div class="pagination-info">
              Affichage de {{ getPaginationInfo() }} événements
            </div> -->
            <nz-pagination 
              [(nzPageIndex)]="currentPage"
              [nzTotal]="evenementsSouscription.length"
              [nzPageSize]="pageSize"
              [nzShowSizeChanger]="false"
              [nzShowQuickJumper]="false"
              [nzSimple]="false"
              (nzPageIndexChange)="onPageChange($event)">
            </nz-pagination>
          </div>
        </div>
      </div>
    </div>
  </section>
</nz-spin>

<!-- MODAL POUR AGRANDIR UNE IMAGE -->
<nz-modal
  [(nzVisible)]="isImageModalVisible"
  (nzOnCancel)="closeImageModal()"
  [nzTitle]="selectedImageTitle"
  [nzFooter]="null"
  [nzWidth]="'80vw'"
  nzCentered>
  
  <div class="image-modal-content" *nzModalContent>
    <img 
      [src]="selectedImageUrl" 
      [alt]="selectedImageTitle"
      class="modal-image"
      (error)="onImageError($event)"
      style="max-width: 100%; height: auto;">
  </div>
</nz-modal>

<!-- MODAL POUR VISUALISER UN PDF -->
<nz-modal
  [(nzVisible)]="isPdfModalVisible"
  (nzOnCancel)="closePdfModal()"
  [nzTitle]="selectedPdfTitle"
  [nzFooter]="null"
  [nzWidth]="'90vw'"
  [nzBodyStyle]="{ height: '80vh', padding: '0' }"
  nzCentered>
  
  <div class="pdf-modal-content" *nzModalContent style="height: 100%;">
    <iframe 
      [src]="selectedPdfUrl" 
      style="width: 100%; height: 100%; border: none;"
      frameborder="0">
      Votre navigateur ne supporte pas l'affichage des PDFs. 
      <a [href]="selectedPdfUrl" target="_blank">Cliquez ici pour ouvrir le PDF</a>
    </iframe>
  </div>
</nz-modal>