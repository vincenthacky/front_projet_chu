<div class="create-user-container">
    <!-- En-tête -->
    <nz-card class="header-card">
      <div class="header-content">
        <h2>
          <span nz-icon nzType="user-add" nzTheme="outline"></span>
          Créer un nouvel utilisateur
        </h2>
        <p class="header-description">
          Remplissez les informations ci-dessous pour créer un nouveau compte utilisateur
        </p>
      </div>
    </nz-card>
  
    <!-- Indicateur de progression du formulaire -->
    <div class="form-progress">
      <nz-progress 
        [nzPercent]="getFormCompletionPercentage()" 
        nzStatus="active"
        [nzShowInfo]="false"
        nzSize="small"
      ></nz-progress>
      <span class="progress-text">Progression: {{ getFormCompletionPercentage() }}%</span>
    </div>
  
    <!-- Formulaire principal -->
    <nz-card class="form-card">
      <form nz-form [formGroup]="createUserForm" nzLayout="vertical" (ngSubmit)="onSubmit()">
        
        <!-- Section Informations personnelles -->
        <div class="form-section">
          <h3 class="section-title">
            <span nz-icon nzType="idcard" nzTheme="outline"></span>
            Informations personnelles
          </h3>
          
          <div nz-row [nzGutter]="16">
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label nzRequired>Nom</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('nom')">
                  <input 
                    nz-input 
                    formControlName="nom" 
                    placeholder="Nom de famille"
                    [class.error-input]="isFieldInvalid('nom')"
                  />
                </nz-form-control>
              </nz-form-item>
            </div>
            
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label nzRequired>Prénom</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('prenom')">
                  <input 
                    nz-input 
                    formControlName="prenom" 
                    placeholder="Prénom"
                    [class.error-input]="isFieldInvalid('prenom')"
                  />
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
  
          <nz-form-item>
            <nz-form-label nzRequired>Email</nz-form-label>
            <nz-form-control [nzErrorTip]="getFieldError('email')">
              <input 
                nz-input 
                formControlName="email" 
                placeholder="adresse@email.com"
                type="email"
                [class.error-input]="isFieldInvalid('email')"
              />
            </nz-form-control>
          </nz-form-item>
  
          <nz-form-item>
            <nz-form-label>Téléphone</nz-form-label>
            <nz-form-control [nzErrorTip]="getFieldError('telephone')">
              <input 
                nz-input 
                formControlName="telephone" 
                placeholder="+225 XX XX XX XX"
                [class.error-input]="isFieldInvalid('telephone')"
              />
            </nz-form-control>
          </nz-form-item>
        </div>
  
        <!-- Section Informations professionnelles -->
        <div class="form-section">
          <h3 class="section-title">
            <span nz-icon nzType="team" nzTheme="outline"></span>
            Informations professionnelles
          </h3>
          
          <div nz-row [nzGutter]="16">
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label>Poste</nz-form-label>
                <nz-form-control>
                  <input 
                    nz-input 
                    formControlName="poste" 
                    placeholder="Poste occupé"
                  />
                </nz-form-control>
              </nz-form-item>
            </div>
            
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label>Service</nz-form-label>
                <nz-form-control>
                  <input 
                    nz-input 
                    formControlName="service" 
                    placeholder="Service/Département"
                  />
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
        </div>
  
        <!-- Section Accès et sécurité -->
        <div class="form-section">
          <h3 class="section-title">
            <span nz-icon nzType="safety-certificate" nzTheme="outline"></span>
            Accès et sécurité
          </h3>
          
          <div nz-row [nzGutter]="16">
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label nzRequired>Type d'utilisateur</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('type')">
                  <nz-select 
                    formControlName="type" 
                    nzPlaceHolder="Sélectionner un type"
                    [class.error-input]="isFieldInvalid('type')"
                  >
                    <nz-option 
                      *ngFor="let option of userTypeOptions" 
                      [nzValue]="option.value" 
                      [nzLabel]="option.label"
                    ></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
            
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label nzRequired>Statut</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('statut_utilisateur')">
                  <nz-select 
                    formControlName="statut_utilisateur" 
                    nzPlaceHolder="Sélectionner un statut"
                    [class.error-input]="isFieldInvalid('statut_utilisateur')"
                  >
                    <nz-option 
                      *ngFor="let option of statusOptions" 
                      [nzValue]="option.value" 
                      [nzLabel]="option.label"
                    ></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
  
          <nz-form-item>
            <nz-form-label nzRequired>Mot de passe</nz-form-label>
            <nz-form-control [nzErrorTip]="getFieldError('mot_de_passe')">
              <nz-input-group [nzSuffix]="suffixTemplate">
                <input 
                  [type]="passwordVisible ? 'text' : 'password'" 
                  nz-input 
                  formControlName="mot_de_passe" 
                  placeholder="Mot de passe"
                  [class.error-input]="isFieldInvalid('mot_de_passe')"
                />
              </nz-input-group>
              <ng-template #suffixTemplate>
                <span 
                  nz-icon 
                  [nzType]="passwordVisible ? 'eye-invisible' : 'eye'" 
                  (click)="passwordVisible = !passwordVisible"
                  class="password-toggle"
                ></span>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
  
          <!-- Indicateur de force du mot de passe -->
          <div class="password-strength-indicator" *ngIf="createUserForm.get('mot_de_passe')?.value">
            <div class="strength-bar">
              <div 
                class="strength-fill" 
                [style.width.%]="getPasswordStrength().level * 20"
                [style.background-color]="getPasswordStrength().color"
              ></div>
            </div>
            <span class="strength-text" [style.color]="getPasswordStrength().color">
              {{ getPasswordStrength().text }}
            </span>
          </div>
  
          <!-- Bouton pour générer un mot de passe -->
          <div class="password-generator">
            <button 
              type="button"
              nz-button 
              nzType="dashed" 
              nzSize="small"
              (click)="generateSecurePassword()"
            >
              <span nz-icon nzType="key"></span>
              Générer un mot de passe sécurisé
            </button>
          </div>
  
          <nz-form-item>
            <nz-form-label nzRequired>Confirmer le mot de passe</nz-form-label>
            <nz-form-control [nzErrorTip]="getFieldError('confirmer_mot_de_passe')">
              <nz-input-group [nzSuffix]="suffixTemplateConfirm">
                <input 
                  [type]="confirmPasswordVisible ? 'text' : 'password'" 
                  nz-input 
                  formControlName="confirmer_mot_de_passe" 
                  placeholder="Confirmer le mot de passe"
                  [class.error-input]="isFieldInvalid('confirmer_mot_de_passe')"
                />
              </nz-input-group>
              <ng-template #suffixTemplateConfirm>
                <span 
                  nz-icon 
                  [nzType]="confirmPasswordVisible ? 'eye-invisible' : 'eye'" 
                  (click)="confirmPasswordVisible = !confirmPasswordVisible"
                  class="password-toggle"
                ></span>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
  
          <nz-form-item>
            <nz-form-control>
              <label nz-checkbox formControlName="est_administrateur">
                <span class="checkbox-label">
                  <span nz-icon nzType="crown" nzTheme="outline"></span>
                  Droits d'administrateur
                </span>
              </label>
              <div class="checkbox-help">
                Cochez cette case pour accorder des privilèges administrateur à cet utilisateur
              </div>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Section Documents (optionnels) -->
        <div class="form-section">
          <h3 class="section-title">
            <span nz-icon nzType="file-text" nzTheme="outline"></span>
            Documents (optionnels)
          </h3>
          
          <div nz-row [nzGutter]="16">
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label>CNI</nz-form-label>
                <nz-form-control>
                  <nz-upload
                    nzAction=""
                    [nzBeforeUpload]="beforeUploadCni"
                    nzAccept="image/*,.pdf"
                    [nzShowUploadList]="false"
                  >
                    <button nz-button nzType="default" type="button" [disabled]="hasFile('cni')">
                      <span nz-icon nzType="upload"></span>
                      {{ hasFile('cni') ? getFileName('cni') : 'Choisir fichier CNI' }}
                    </button>
                  </nz-upload>
                  <button 
                    *ngIf="hasFile('cni')" 
                    nz-button 
                    nzType="text" 
                    nzDanger 
                    nzSize="small"
                    type="button"
                    (click)="removeFile('cni')"
                    style="margin-left: 8px;"
                  >
                    <span nz-icon nzType="delete"></span>
                  </button>
                  
                  <!-- Aperçu du fichier CNI -->
                  <div *ngIf="cniPreview" class="file-preview-container">
                    <div class="file-preview-card">
                      <div *ngIf="cniPreview !== 'pdf'" class="image-preview">
                        <img [src]="cniPreview" alt="Aperçu CNI" />
                      </div>
                      <div *ngIf="cniPreview === 'pdf'" class="pdf-preview">
                        <span nz-icon nzType="file-pdf" nzTheme="twotone" nzTwotoneColor="#ff4d4f"></span>
                        <span>{{ getFileName('cni') }}</span>
                      </div>
                    </div>
                  </div>
                </nz-form-control>
              </nz-form-item>
            </div>
            
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label>Carte professionnelle</nz-form-label>
                <nz-form-control>
                  <nz-upload
                    nzAction=""
                    [nzBeforeUpload]="beforeUploadCartePro"
                    nzAccept="image/*,.pdf"
                    [nzShowUploadList]="false"
                  >
                    <button nz-button nzType="default" type="button" [disabled]="hasFile('carte_professionnel')">
                      <span nz-icon nzType="upload"></span>
                      {{ hasFile('carte_professionnel') ? getFileName('carte_professionnel') : 'Choisir carte pro' }}
                    </button>
                  </nz-upload>
                  <button 
                    *ngIf="hasFile('carte_professionnel')" 
                    nz-button 
                    nzType="text" 
                    nzDanger 
                    nzSize="small"
                    type="button"
                    (click)="removeFile('carte_professionnel')"
                    style="margin-left: 8px;"
                  >
                    <span nz-icon nzType="delete"></span>
                  </button>
                  
                  <!-- Aperçu du fichier Carte Pro -->
                  <div *ngIf="carteProPreview" class="file-preview-container">
                    <div class="file-preview-card">
                      <div *ngIf="carteProPreview !== 'pdf'" class="image-preview">
                        <img [src]="carteProPreview" alt="Aperçu Carte Pro" />
                      </div>
                      <div *ngIf="carteProPreview === 'pdf'" class="pdf-preview">
                        <span nz-icon nzType="file-pdf" nzTheme="twotone" nzTwotoneColor="#ff4d4f"></span>
                        <span>{{ getFileName('carte_professionnel') }}</span>
                      </div>
                    </div>
                  </div>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <div nz-row [nzGutter]="16">
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label>Fiche de souscription</nz-form-label>
                <nz-form-control>
                  <nz-upload
                    nzAction=""
                    [nzBeforeUpload]="beforeUploadFicheSouscription"
                    nzAccept="image/*,.pdf"
                    [nzShowUploadList]="false"
                  >
                    <button nz-button nzType="default" type="button" [disabled]="hasFile('fiche_souscription')">
                      <span nz-icon nzType="upload"></span>
                      {{ hasFile('fiche_souscription') ? getFileName('fiche_souscription') : 'Choisir fiche souscription' }}
                    </button>
                  </nz-upload>
                  <button 
                    *ngIf="hasFile('fiche_souscription')" 
                    nz-button 
                    nzType="text" 
                    nzDanger 
                    nzSize="small"
                    type="button"
                    (click)="removeFile('fiche_souscription')"
                    style="margin-left: 8px;"
                  >
                    <span nz-icon nzType="delete"></span>
                  </button>
                  
                  <!-- Aperçu du fichier Fiche Souscription -->
                  <div *ngIf="ficheSouscriptionPreview" class="file-preview-container">
                    <div class="file-preview-card">
                      <div *ngIf="ficheSouscriptionPreview !== 'pdf'" class="image-preview">
                        <img [src]="ficheSouscriptionPreview" alt="Aperçu Fiche Souscription" />
                      </div>
                      <div *ngIf="ficheSouscriptionPreview === 'pdf'" class="pdf-preview">
                        <span nz-icon nzType="file-pdf" nzTheme="twotone" nzTwotoneColor="#ff4d4f"></span>
                        <span>{{ getFileName('fiche_souscription') }}</span>
                      </div>
                    </div>
                  </div>
                </nz-form-control>
              </nz-form-item>
            </div>
            
            <div nz-col nzXs="24" nzSm="12" nzMd="12">
              <nz-form-item>
                <nz-form-label>Photo de profil</nz-form-label>
                <nz-form-control>
                  <nz-upload
                    nzAction=""
                    [nzBeforeUpload]="beforeUploadPhotoProfil"
                    nzAccept="image/*"
                    [nzShowUploadList]="false"
                  >
                    <button nz-button nzType="default" type="button" [disabled]="hasFile('photo_profil')">
                      <span nz-icon nzType="upload"></span>
                      {{ hasFile('photo_profil') ? getFileName('photo_profil') : 'Choisir photo profil' }}
                    </button>
                  </nz-upload>
                  <button 
                    *ngIf="hasFile('photo_profil')" 
                    nz-button 
                    nzType="text" 
                    nzDanger 
                    nzSize="small"
                    type="button"
                    (click)="removeFile('photo_profil')"
                    style="margin-left: 8px;"
                  >
                    <span nz-icon nzType="delete"></span>
                  </button>
                  
                  <!-- Aperçu du fichier Photo Profil -->
                  <div *ngIf="photoProfilPreview" class="file-preview-container">
                    <div class="file-preview-card">
                      <div *ngIf="photoProfilPreview !== 'pdf'" class="image-preview">
                        <img [src]="photoProfilPreview" alt="Aperçu Photo Profil" />
                      </div>
                      <div *ngIf="photoProfilPreview === 'pdf'" class="pdf-preview">
                        <span nz-icon nzType="file-pdf" nzTheme="twotone" nzTwotoneColor="#ff4d4f"></span>
                        <span>{{ getFileName('photo_profil') }}</span>
                      </div>
                    </div>
                  </div>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <div class="documents-info">
            <nz-alert
              nzType="info"
              nzMessage="Information sur les documents"
              nzDescription="Tous les documents sont facultatifs. Formats acceptés : Images (JPG, PNG, GIF) et PDF. Taille maximale : 5MB par fichier. Les images seront automatiquement compressées pour optimiser l'envoi."
              nzShowIcon
            ></nz-alert>
          </div>
        </div>
  
        <!-- Aperçu des données utilisateur -->
        <div class="user-preview" *ngIf="createUserForm.valid">
          <nz-alert
            nzType="info"
            nzMessage="Aperçu de l'utilisateur"
            nzShowIcon
            [nzDescription]="userPreviewTemplate"
          ></nz-alert>
          
          <ng-template #userPreviewTemplate>
            <div class="preview-content">
              <p><strong>Nom complet:</strong> {{ createUserForm.get('prenom')?.value }} {{ createUserForm.get('nom')?.value }}</p>
              <p><strong>Email:</strong> {{ createUserForm.get('email')?.value }}</p>
              <p><strong>Type:</strong> {{ getUserTypeLabel(createUserForm.get('type')?.value) }}</p>
              <p><strong>Statut:</strong> {{ getStatusLabel(createUserForm.get('statut_utilisateur')?.value) }}</p>
              <p *ngIf="createUserForm.get('poste')?.value"><strong>Poste:</strong> {{ createUserForm.get('poste')?.value }}</p>
              <p *ngIf="createUserForm.get('service')?.value"><strong>Service:</strong> {{ createUserForm.get('service')?.value }}</p>
              <p><strong>Administrateur:</strong> {{ createUserForm.get('est_administrateur')?.value ? 'Oui' : 'Non' }}</p>
            </div>
          </ng-template>
        </div>
  
        <!-- Boutons d'action -->
        <div class="form-actions" style="margin-top: 20px;">
          <nz-space nzSize="middle">
            <button 
              *nzSpaceItem
              nz-button 
              nzType="default" 
              (click)="onCancel()"
              [disabled]="isSubmitting"
            >
              <span nz-icon nzType="close"></span>
              Annuler
            </button>
            
            <button 
              *nzSpaceItem
              nz-button 
              nzType="default" 
              (click)="onReset()"
              [disabled]="isSubmitting"
            >
              <span nz-icon nzType="reload"></span>
              Réinitialiser
            </button>
  
            <button 
              *nzSpaceItem
              nz-button 
              nzType="dashed" 
              (click)="saveDraft()"
              [disabled]="isSubmitting"
            >
              <span nz-icon nzType="save"></span>
              Sauvegarder brouillon
            </button>
            
            <button 
              *nzSpaceItem
              nz-button 
              nzType="primary" 
              [nzLoading]="isSubmitting"
              [disabled]="!createUserForm.valid"
              type="submit"
            >
              <span nz-icon nzType="user-add" *ngIf="!isSubmitting"></span>
              {{ isSubmitting ? 'Création en cours...' : 'Créer l\'utilisateur' }}
            </button>
          </nz-space>
        </div>
      </form>
    </nz-card>
  
    <!-- Informations d'aide -->
    <nz-card class="help-card">
      <div class="help-content">
        <h4>
          <span nz-icon nzType="question-circle" nzTheme="outline"></span>
          Informations importantes
        </h4>
        <ul class="help-list">
          <li>Les champs marqués d'un astérisque (*) sont obligatoires</li>
          <li>Le mot de passe doit contenir au moins 8 caractères avec majuscules, minuscules, chiffres et caractères spéciaux</li>
          <li>L'email doit être unique dans le système</li>
          <li>Le numéro de téléphone doit être au format international (+225...)</li>
          <li>Les droits d'administrateur permettent la gestion complète du système</li>
          <li>Un brouillon est automatiquement sauvegardé toutes les 2 secondes</li>
        </ul>
      </div>
    </nz-card>
  </div>