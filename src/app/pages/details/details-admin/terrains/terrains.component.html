<div class="terrain-admin-container">
  <div class="container-header" >
    <h2 class="page-title">
      <i nz-icon nzType="environment" nzTheme="outline"></i>
      Gestion des Terrains
    </h2>
  </div>

  <div class="main-content" nz-row [nzGutter]="[16, 16]">
    <!-- Formulaire responsive -->
    <div nz-col nzXs="24" nzSm="24" nzMd="24" nzLg="12" nzXl="10">
      <nz-card 
        class="form-card"
        [nzTitle]="isEditMode ? 'Modifier le Terrain' : 'Créer un Nouveau Terrain'"
        [nzExtra]="formExtraTemplate">
        
        <ng-template #formExtraTemplate>
          <button 
            *ngIf="isEditMode" 
            nz-button 
            nzType="default" 
            nzSize="small"
            (click)="resetForm()"
            nz-tooltip="Annuler la modification">
            <i nz-icon nzType="close"></i>
          </button>
        </ng-template>

        <form nz-form [formGroup]="terrainForm" (ngSubmit)="onSubmit()">
          <!-- Libellé -->
          <nz-form-item>
            <nz-form-label nzFor="libelle" [nzXs]="{ span: 24 }" [nzSm]="{ span: 8 }" [nzMd]="{ span: 6 }" nzRequired>
              Libellé
            </nz-form-label>
            <nz-form-control 
              [nzXs]="{ span: 24 }"
              [nzSm]="{ span: 16 }"
              [nzMd]="{ span: 18 }"
              [nzErrorTip]="getFieldError('libelle')"
              [nzValidateStatus]="isFieldError('libelle') ? 'error' : ''">
              <input 
                nz-input 
                formControlName="libelle" 
                id="libelle"
                placeholder="Ex: Terrain Alpha">
            </nz-form-control>
          </nz-form-item>

          <!-- Localisation -->
          <nz-form-item>
            <nz-form-label nzFor="localisation" [nzXs]="{ span: 24 }" [nzSm]="{ span: 8 }" [nzMd]="{ span: 10 }" nzRequired>
              Localisation
            </nz-form-label>
            <nz-form-control 
              [nzXs]="{ span: 24 }"
              [nzSm]="{ span: 16 }"
              [nzMd]="{ span: 18 }"
              [nzErrorTip]="getFieldError('localisation')"
              [nzValidateStatus]="isFieldError('localisation') ? 'error' : ''">
              <input 
                nz-input 
                formControlName="localisation" 
                id="localisation"
                placeholder="Ex: Abidjan, Cocody">
            </nz-form-control>
          </nz-form-item>

          <!-- Superficie -->
          <nz-form-item>
            <nz-form-label [nzXs]="{ span: 24 }" [nzSm]="{ span: 8 }" [nzMd]="{ span: 12 }" nzRequired>
              Superficie (m²)
            </nz-form-label>
            <nz-form-control 
              [nzXs]="{ span: 24 }"
              [nzSm]="{ span: 16 }"
              [nzMd]="{ span: 18 }"
              [nzErrorTip]="getFieldError('superficie')"
              [nzValidateStatus]="isFieldError('superficie') ? 'error' : ''">
              <nz-input-number
                formControlName="superficie"
                [nzMin]="1"
                [nzMax]="999999"
                [nzStep]="0.01"
                [nzPrecision]="2"
                nzPlaceHolder="500.75"
                class="full-width-input" />
            </nz-form-control>
          </nz-form-item>

            <!-- montant mensuel -->
            <nz-form-item>
              <nz-form-label [nzXs]="{ span: 24 }" [nzSm]="{ span: 8 }" [nzMd]="{ span: 12 }" nzRequired>
                montant mensuel 
              </nz-form-label>
              <nz-form-control 
                [nzXs]="{ span: 24 }"
                [nzSm]="{ span: 16 }"
                [nzMd]="{ span: 18 }"
                [nzErrorTip]="getFieldError('montant_mensuel')"
                [nzValidateStatus]="isFieldError('montant_mensuel') ? 'error' : ''">
                <nz-input-number
                  formControlName="montant_mensuel"
                  [nzMin]="1"
                  [nzMax]="999999999"
                  [nzFormatter]="currencyFormatter"
                  [nzParser]="currencyParser"
                  (ngModelChange)="onMontantMensuelChange($event)"
                  nzPlaceHolder="250000"
                  class="full-width-input" />
              </nz-form-control>
            </nz-form-item>

          <!-- Prix unitaire -->
          <nz-form-item>
            <nz-form-label [nzXs]="{ span: 24 }" [nzSm]="{ span: 8 }" [nzMd]="{ span: 12 }" nzRequired>
              Prix Total 
            </nz-form-label>
            <nz-form-control 
              [nzXs]="{ span: 24 }"
              [nzSm]="{ span: 16 }"
              [nzMd]="{ span: 18 }"
              [nzErrorTip]="getFieldError('prix_unitaire')"
              [nzValidateStatus]="isFieldError('prix_unitaire') ? 'error' : ''">
              <nz-input-number
                formControlName="prix_unitaire"
                [nzMin]="1"
                [nzMax]="999999999"
                [nzFormatter]="currencyFormatter"
                [nzParser]="currencyParser"
                (ngModelChange)="onPrixUnitaireChange($event)"
                nzPlaceHolder="250000"
                class="full-width-input" />
            </nz-form-control>
          </nz-form-item>

          

          <!-- Statut -->
          <nz-form-item>
            <nz-form-label [nzXs]="{ span: 24 }" [nzSm]="{ span: 8 }" [nzMd]="{ span: 6 }" nzRequired>
              Statut
            </nz-form-label>
            <nz-form-control [nzXs]="{ span: 24 }" [nzSm]="{ span: 16 }" [nzMd]="{ span: 18 }">
              <nz-select formControlName="statut_terrain" nzPlaceHolder="Sélectionner le statut">
                <nz-option 
                  *ngFor="let status of statusOptions" 
                  [nzLabel]="status.label" 
                  [nzValue]="status.value">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>

          <!-- Description -->
          <nz-form-item>
            <nz-form-label [nzXs]="{ span: 24 }" [nzSm]="{ span: 8 }" [nzMd]="{ span: 12 }" nzRequired>
              Description
            </nz-form-label>
            <nz-form-control 
              [nzXs]="{ span: 24 }"
              [nzSm]="{ span: 16 }"
              [nzMd]="{ span: 18 }"
              [nzErrorTip]="getFieldError('description')"
              [nzValidateStatus]="isFieldError('description') ? 'error' : ''">
              <textarea 
                nz-input 
                formControlName="description"
                [rows]="3"
                placeholder="Description détaillée du terrain...">
              </textarea>
            </nz-form-control>
          </nz-form-item>

          <!-- Boutons responsive -->
          <nz-form-item class="form-actions">
            <nz-form-control [nzXs]="{ span: 24, offset: 0 }" [nzSm]="{ span: 16, offset: 8 }" [nzMd]="{ span: 18, offset: 6 }">
              <div class="button-group">
                <button 
                  nz-button 
                  nzType="primary" 
                  type="submit"
                  [nzLoading]="submitting"
                  [disabled]="!terrainForm.valid || submitting"
                  class="submit-button">
                  <i nz-icon [nzType]="isEditMode ? 'edit' : 'plus'"></i>
                  {{ isEditMode ? 'Modifier' : 'Créer' }}
                </button>
                
                <button 
                  *ngIf="isEditMode"
                  nz-button 
                  type="button"
                  nzType="default"
                  (click)="resetForm()"
                  class="cancel-button">
                  <i nz-icon nzType="undo"></i>
                  Annuler
                </button>
              </div>
            </nz-form-control>
          </nz-form-item>
        </form>
      </nz-card>
    </div>

    <!-- Liste et détails responsive -->
    <div nz-col nzXs="24" nzSm="24" nzMd="24" nzLg="12" nzXl="14">
      <!-- Liste des terrains en grille responsive -->
      <div class="terrain-grid" nz-row [nzGutter]="[8, 8]">
        <div 
          *ngFor="let terrain of terrains; trackBy: trackByTerrain" 
          nz-col 
          nzXs="24" 
          nzSm="12" 
          nzMd="8" 
          nzLg="6" 
          nzXl="6"
          class="terrain-card-wrapper">
          <nz-card 
            class="terrain-card"
            [class.selected]="selectedTerrain?.id_terrain === terrain.id_terrain"
            (click)="selectTerrain(terrain)"
            [nzBodyStyle]="{ padding: '12px' }">
            
            <!-- Header avec titre et actions -->
            <div class="card-header">
              <h4 class="terrain-title">{{ terrain.libelle }}</h4>
              <div class="card-actions">
                <button 
                  nz-button 
                  nzType="text" 
                  nzSize="small"
                  (click)="editTerrain(terrain); $event.stopPropagation()"
                  nz-tooltip="Modifier"
                  class="action-btn">
                  <i nz-icon nzType="edit" nzTheme="outline"></i>
                </button>
                <!-- <button 
                  nz-button 
                  nzType="text" 
                  nzSize="small" 
                  nzDanger
                  (click)="deleteTerrain(terrain); $event.stopPropagation()"
                  nz-tooltip="Supprimer"
                  class="action-btn">
                  <i nz-icon nzType="delete" nzTheme="outline"></i>
                </button> -->
              </div>
            </div>
            
            <!-- Contenu de la carte -->
            <div class="card-content">
              <div class="location">
                <i nz-icon nzType="environment" nzTheme="outline"></i>
                <span>{{ terrain.localisation }}</span>
              </div>
              
              <div class="terrain-stats">
                <div class="stat">
                  <span class="stat-value">{{ formatSuperficie(terrain.superficie) }}</span>
                </div>
                <nz-tag [nzColor]="getStatusColor(terrain.statut_terrain)" class="status-tag">
                  {{ getStatusLabel(terrain.statut_terrain) }}
                </nz-tag>
              </div>
            </div>
          </nz-card>
        </div>
      </div>

      <!-- Détail du terrain sélectionné -->
      <div *ngIf="selectedTerrain" class="terrain-detail" style="margin-top: 20px;">
        <nz-card 
          class="detail-card"
          [nzTitle]="selectedTerrain.libelle"
          [nzExtra]="cardActionsTemplate">
          
          <ng-template #cardActionsTemplate>
            <div class="detail-actions">
              <button 
                nz-button 
                nzType="text" 
                nzSize="small"
                (click)="editTerrain(selectedTerrain!)"
                nz-tooltip="Modifier ce terrain">
                <i nz-icon nzType="edit" nzTheme="outline"></i>
              </button>
              <!-- <button 
                nz-button 
                nzType="text" 
                nzSize="small" 
                nzDanger
                (click)="deleteTerrain(selectedTerrain!)"
                nz-tooltip="Supprimer ce terrain">
                <i nz-icon nzType="delete" nzTheme="outline"></i>
              </button> -->
            </div>
          </ng-template>

          <div class="detail-content">
            <!-- Header du détail -->
            <div class="detail-header">
              <nz-tag [nzColor]="getStatusColor(selectedTerrain.statut_terrain)" class="status-tag-large">
                {{ getStatusLabel(selectedTerrain.statut_terrain) }}
              </nz-tag>
              <span class="creation-date">
                Créé le {{ formatDate(selectedTerrain.date_creation) }}
              </span>
            </div>

            <!-- Informations principales en grille responsive -->
            <div class="detail-section">
              <h4>Informations générales</h4>
              <div class="info-grid">
                <div class="info-card">
                  <div class="info-label">
                    <i nz-icon nzType="environment" nzTheme="outline"></i>
                    Localisation
                  </div>
                  <div class="info-value">{{ selectedTerrain.localisation }}</div>
                </div>
                
                <div class="info-card">
                  <div class="info-label">
                    <i nz-icon nzType="border-outer" nzTheme="outline"></i>
                    Superficie
                  </div>
                  <div class="info-value">{{ formatSuperficie(selectedTerrain.superficie) }}</div>
                </div>
                <div class="info-card">
                  <div class="info-label">
                    <i nz-icon nzType="dollar" nzTheme="outline"></i>
                 Montant mensuel
                  </div>
                  <div class="info-value price">{{ formatPrice(selectedTerrain.montant_mensuel) }}/m²</div>
                </div>

                <div class="info-card">
                  <div class="info-label">
                    <i nz-icon nzType="dollar" nzTheme="outline"></i>
                    Prix Total estimé
                  </div>
                  <div class="info-value price">{{ formatPrice(selectedTerrain.prix_unitaire) }}/m²</div>
                </div>
             
                
                <!-- <div class="info-card">
                  <div class="info-label">
                    <i nz-icon nzType="calculator" nzTheme="outline"></i>
                    Prix total estimé
                  </div>
                  <div class="info-value total-price">
                    {{ calculateTotalPrice(selectedTerrain) }}
                  </div>
                </div> -->
              </div>
            </div>

            <!-- Description -->
            <div class="detail-section">
              <h4>Description</h4>
              <div class="description-content">
                <p class="description-text">{{ selectedTerrain.description }}</p>
              </div>
            </div>

            <!-- Métadonnées -->
            <div class="detail-section">
              <h4>Métadonnées</h4>
              <div class="metadata-grid">
                <div class="metadata-item">
                  <span class="metadata-label">ID Terrain:</span>
                  <span class="metadata-value">#{{ selectedTerrain.id_terrain }}</span>
                </div>
                <div class="metadata-item" *ngIf="selectedTerrain.created_at">
                  <span class="metadata-label">Créé le:</span>
                  <span class="metadata-value">{{ formatDate(selectedTerrain.created_at) }}</span>
                </div>
                <div class="metadata-item" *ngIf="selectedTerrain.updated_at">
                  <span class="metadata-label">Modifié le:</span>
                  <span class="metadata-value">{{ formatDate(selectedTerrain.updated_at) }}</span>
                </div>
              </div>
            </div>
          </div>
        </nz-card>
      </div>

      <!-- État vide -->
      <div *ngIf="!loading && terrains.length === 0" class="empty-state">
        <nz-card>
          <div class="empty-content">
            <i nz-icon nzType="inbox" nzTheme="outline" class="empty-icon"></i>
            <h3>Aucun terrain disponible</h3>
            <p>Commencez par créer votre premier terrain en utilisant le formulaire ci-dessus.</p>
          </div>
        </nz-card>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <nz-spin nzSize="large" nzTip="Chargement des terrains..."></nz-spin>
  </div>
</div>