import './polyfills.server.mjs';
import{a as S}from"./chunk-KHW4IOFH.mjs";import{e as R}from"./chunk-LI7RJ6PT.mjs";import{b as d,g as w}from"./chunk-UXVSRWVF.mjs";import{F as y}from"./chunk-SYXLOHCJ.mjs";import{E as u,Na as I,_ as a,da as v,g,ia as b,ja as f,n as U,o as n,r as c}from"./chunk-OQNIVP4F.mjs";import{a as p}from"./chunk-5XUXGTUW.mjs";var T=class h{constructor(t){this.platformId=t;this.isBrowser=y(this.platformId),this.isBrowser&&(this.checkAuthStatus(),this.setupInactivityDetection())}API_URL=S.apiUrl;http=f(w);router=f(R);currentUserSubject=new g(null);isAuthenticatedSubject=new g(!1);inactivityTimer;lastActivityTime=0;INACTIVITY_TIMEOUT=30*60*1e3;activityListeners=[];isBrowser;currentUser$=this.currentUserSubject.asObservable();isAuthenticated$=this.isAuthenticatedSubject.asObservable();decodeUnicodeString(t){if(!t||typeof t!="string")return t;try{let e=t.replace(/\\u([\dA-Fa-f]{4})/g,(r,s)=>String.fromCharCode(parseInt(s,16)));e=e.replace(/&#(\d+);/g,(r,s)=>String.fromCharCode(s));let o={"&eacute;":"\xE9","&egrave;":"\xE8","&ecirc;":"\xEA","&agrave;":"\xE0","&acirc;":"\xE2","&ccedil;":"\xE7","&ocirc;":"\xF4","&ugrave;":"\xF9","&ucirc;":"\xFB","&icirc;":"\xEE","&ntilde;":"\xF1","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};for(let[r,s]of Object.entries(o))e=e.replace(new RegExp(r,"g"),s);try{e.includes("%")&&(e=decodeURIComponent(e))}catch(r){console.warn("Erreur decodeURIComponent:",r)}return e}catch(e){return console.warn("Erreur d\xE9codage Unicode pour:",t,e),t}}decodeUnicodeInObject(t){if(t==null)return t;if(typeof t=="string")return this.decodeUnicodeString(t);if(Array.isArray(t))return t.map(e=>this.decodeUnicodeInObject(e));if(typeof t=="object"){let e={};for(let o in t)if(Object.prototype.hasOwnProperty.call(t,o)){let r=this.decodeUnicodeString(o);e[r]=this.decodeUnicodeInObject(t[o])}return e}return t}testDecoding(){let t=["Connexion r\\u00e9ussie","D\\u00e9veloppeur","D\\u00e9connexion effectu\\u00e9e avec succ\\u00e8s"];console.log("\u{1F9EA} Test de d\xE9codage Unicode:"),t.forEach(e=>{let o=this.decodeUnicodeString(e);console.log(`   "${e}" \u2192 "${o}"`)})}login(t){return this.http.post(`${this.API_URL}/login`,t).pipe(a(e=>{console.log("\u{1F4E8} R\xE9ponse API brute:",e)}),c(e=>{let o=this.decodeUnicodeInObject(e);return console.log("\u{1F4E8} R\xE9ponse API d\xE9cod\xE9e:",o),o}),c(e=>{if(e.success===!0&&e.data&&e.data.user&&e.data.token){let o=e.data.user;if(o.type!=="user"&&o.type!=="superAdmin")throw console.error("\u274C R\xF4le non autoris\xE9:",o.type),new Error("Acc\xE8s non authoris\xE9");if(o.statut_utilisateur.toLowerCase()!=="actif")throw console.error("\u274C Statut non actif:",o.statut_utilisateur),new Error("Compte non actif");return e}else throw console.error("\u274C Structure de r\xE9ponse inattendue:",e),new Error("Structure de r\xE9ponse invalide")}),a(e=>{console.log("\u2705 Connexion r\xE9ussie, stockage des donn\xE9es..."),this.setAuthData(e.data.user,e.data.token)}),u(e=>(console.error("\u274C Erreur de connexion:",e),e.error&&(e.error=this.decodeUnicodeInObject(e.error)),n(e))))}logout(){console.log("\u{1F6AA} D\xE9connexion en cours...");let t=this.getToken();if(console.log("\u{1F50D} Token r\xE9cup\xE9r\xE9:",t?"Token pr\xE9sent (longueur: "+t.length+")":"Aucun token"),this.isBrowser&&t){console.log("\u{1F511} Token d\xE9tect\xE9, tentative de logout backend...");let e={Authorization:`Bearer ${t}`,"Content-Type":"application/json"};this.http.post(`${this.API_URL}/logout`,{},{headers:e}).pipe(c(o=>this.decodeUnicodeInObject(o))).subscribe({next:o=>{console.log("\u2705 SUCC\xC8S! R\xE9ponse backend d\xE9cod\xE9e:",o),console.log("\u{1F389} Message:",o.message),this.completeLogout()},error:o=>{console.log("\u{1F4CA} ERREUR logout backend:",o),o.error&&(o.error=this.decodeUnicodeInObject(o.error)),console.log("\u26A0\uFE0F Erreur backend, d\xE9connexion locale quand m\xEAme"),this.completeLogout()}})}else console.log("\u26A0\uFE0F Pas de token, d\xE9connexion directe"),this.completeLogout()}completeLogout(){this.stopInactivityDetection(),this.isBrowser&&(localStorage.removeItem("user"),localStorage.removeItem("token"),localStorage.removeItem("authExpiry")),this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1),console.log("\u{1F6AA} D\xE9connexion termin\xE9e"),this.isBrowser&&this.router.navigate(["/authentification/login"])}manualLogout(){this.logout()}forceLogout(){console.log("\u{1F6AA} D\xE9connexion forc\xE9e (token invalide)"),this.completeLogout()}resetUserState(){console.log("\u{1F504} R\xE9initialisation de l'\xE9tat utilisateur sans redirection"),this.stopInactivityDetection(),this.isBrowser&&(localStorage.removeItem("user"),localStorage.removeItem("token"),localStorage.removeItem("authExpiry")),this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1)}setAuthData(t,e){if(!this.isBrowser)return;let o=this.decodeUnicodeInObject(t);console.log("\u{1F4DD} Stockage utilisateur d\xE9cod\xE9:",o);let r=new Date().getTime()+24*60*60*1e3;console.log("\u23F0 Expiration token pr\xE9vue \xE0:",new Date(r)),localStorage.setItem("user",JSON.stringify(o)),localStorage.setItem("token",e),localStorage.setItem("authExpiry",r.toString()),this.currentUserSubject.next(o),this.isAuthenticatedSubject.next(!0),this.startInactivityDetection()}checkAuthStatus(){if(!this.isBrowser)return;let t=localStorage.getItem("user"),e=localStorage.getItem("token"),o=localStorage.getItem("authExpiry");if(console.log("\u{1F50D} V\xE9rification statut authentification:",{user:!!t,token:!!e,expiry:!!o}),t&&e&&o){let r=new Date().getTime(),s=parseInt(o,10);if(r<s)try{let i=JSON.parse(t);if(i=this.decodeUnicodeInObject(i),i.type!=="user"&&i.type!=="superAdmin"){console.error("\u274C R\xF4le non autoris\xE9 au chargement:",i.type),this.forceLogout();return}if(i.statut_utilisateur.toLowerCase()!=="actif"){console.error("\u274C Statut non actif au chargement:",i.statut_utilisateur),this.forceLogout();return}console.log("\u2705 Session valide - Utilisateur connect\xE9 (d\xE9cod\xE9):",i),this.currentUserSubject.next(i),this.isAuthenticatedSubject.next(!0),this.startInactivityDetection()}catch(i){console.error("\u274C Erreur lors du parsing des donn\xE9es utilisateur:",i),this.forceLogout()}else console.log("\u23F0 Token expir\xE9 au d\xE9marrage"),this.forceLogout()}else console.log("\u{1F50D} Aucune session trouv\xE9e")}forgotPassword(t){return this.http.post(`${this.API_URL}/password/send-token`,{email:t}).pipe(a(e=>{console.log("\u{1F4E7} R\xE9ponse brute envoi token:",e)}),c(e=>{let o=this.decodeUnicodeInObject(e);return console.log("\u{1F4E7} R\xE9ponse d\xE9cod\xE9e envoi token:",o),o}),u(e=>(console.error("\u274C Erreur envoi token:",e),e.error&&(e.error=this.decodeUnicodeInObject(e.error)),n(e))))}resetPassword(t,e,o){console.log("\u{1F510} Service resetPassword appel\xE9 avec:"),console.log("   - Token (longueur):",t?t.length:"null/undefined");let r={token_reset:t,mot_de_passe:e,mot_de_passe_confirmation:o};return this.http.post(`${this.API_URL}/password/reset`,r).pipe(a(s=>{console.log("\u{1F510} R\xE9ponse brute r\xE9initialisation:",s)}),c(s=>{let i=this.decodeUnicodeInObject(s);return console.log("\u{1F510} R\xE9ponse d\xE9cod\xE9e r\xE9initialisation:",i),i}),u(s=>(console.error("\u274C Erreur r\xE9initialisation mot de passe:",s),s.error&&(s.error=this.decodeUnicodeInObject(s.error)),n(s))))}updateProfile(t){return this.http.put(`${this.API_URL}/profile`,t).pipe(c(e=>this.decodeUnicodeInObject(e)),a(e=>{if(e&&e.user&&this.isBrowser){let o=this.getCurrentUser();if(o){let r=p(p({},o),e.user);localStorage.setItem("user",JSON.stringify(r)),this.currentUserSubject.next(r),console.log("\u{1F464} Profil personnel mis \xE0 jour (d\xE9cod\xE9):",r)}}}),u(e=>(console.error("\u274C Erreur mise \xE0 jour profil personnel:",e),e.error&&(e.error=this.decodeUnicodeInObject(e.error)),n(e))))}updatePassword(t){let e=this.getToken();if(!e)return console.error("\u274C Aucun token d'authentification trouv\xE9"),n(()=>new Error("Utilisateur non authentifi\xE9"));let o=new d({"Content-Type":"application/json",Authorization:`Bearer ${e}`});return this.http.post(`${this.API_URL}/password/update`,t,{headers:o}).pipe(a(r=>console.log("\u{1F4E8} R\xE9ponse brute mise \xE0 jour mot de passe:",r)),c(r=>this.decodeUnicodeInObject(r)),u(r=>(console.error("\u274C Erreur mise \xE0 jour mot de passe:",r),r.error&&(r.error=this.decodeUnicodeInObject(r.error)),n(()=>new Error(r.error?.message||"Erreur serveur")))))}setupInactivityDetection(){if(!this.isBrowser)return;["mousedown","mousemove","keypress","scroll","touchstart","click","keydown"].forEach(e=>{let o=()=>this.resetInactivityTimer();document.addEventListener(e,o,!0),this.activityListeners.push(()=>{document.removeEventListener(e,o,!0)})}),console.log("\u{1F442} D\xE9tection d'activit\xE9 configur\xE9e")}startInactivityDetection(){this.isBrowser&&(this.lastActivityTime=Date.now(),this.resetInactivityTimer(),console.log("\u23F0 Surveillance d'inactivit\xE9 d\xE9marr\xE9e (30 minutes)"))}resetInactivityTimer(){!this.isBrowser||!this.isAuthenticated()||(this.lastActivityTime=Date.now(),this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.inactivityTimer=window.setTimeout(()=>{this.handleInactivityTimeout()},this.INACTIVITY_TIMEOUT))}handleInactivityTimeout(){console.log("\u23F0 D\xE9connexion pour inactivit\xE9 (30 minutes sans activit\xE9)"),this.forceLogout()}stopInactivityDetection(){this.isBrowser&&(this.inactivityTimer&&(clearTimeout(this.inactivityTimer),this.inactivityTimer=void 0),this.activityListeners.forEach(t=>t()),this.activityListeners=[],console.log("\u{1F6D1} Surveillance d'inactivit\xE9 arr\xEAt\xE9e"))}isSessionValid(){if(!this.isBrowser)return!1;let t=localStorage.getItem("authExpiry"),e=localStorage.getItem("token");if(!t||!e)return!1;let o=new Date().getTime(),r=parseInt(t,10);return o<r}getCurrentUser(){let t=this.currentUserSubject.value;return console.log("\u{1F50D} Utilisateur connect\xE9 r\xE9cup\xE9r\xE9:",t),t}isAuthenticated(){return this.isAuthenticatedSubject.value}isAdmin(){let t=this.getCurrentUser();if(!t)return!1;let e=t.est_administrateur||t.type==="superAdmin";return console.log("\u{1F50D} V\xE9rification admin:",{userId:t.id_utilisateur,isAdmin:e}),e}isUser(){let t=this.getCurrentUser();return t?!t.est_administrateur&&t.type!=="superAdmin":!1}getToken(){if(!this.isBrowser)return null;let t=localStorage.getItem("token"),e=localStorage.getItem("authExpiry");if(!t||!e)return null;let o=new Date().getTime(),r=parseInt(e,10);return o>=r?null:t}getTimeUntilInactivityLogout(){if(!this.isBrowser||!this.isAuthenticated())return 0;let t=Date.now()-this.lastActivityTime,e=this.INACTIVITY_TIMEOUT-t;return Math.max(0,Math.ceil(e/1e3))}redirectAfterLogin(){if(!this.isBrowser)return;let t=this.getCurrentUser();if(console.log("\u{1F504} Redirection - Utilisateur complet:",t),t){let e=this.isAdmin();console.log("\u{1F504} Est admin?",e),setTimeout(()=>{e?(console.log("\u2192 Redirection vers admin dashboard"),this.router.navigate(["/dashboard/admin/details"])):(console.log("\u2192 Redirection vers user dashboard"),this.router.navigate(["/dashboard/user/details"]))},100)}else console.error("\u274C Aucun utilisateur trouv\xE9 pour la redirection"),this.router.navigate(["/authentification/login"])}checkServerStatus(){return this.http.get(`${this.API_URL}/status`).pipe(u(t=>(console.error("\u274C Serveur inaccessible:",t),n(t))))}diagnosticToken(){if(!this.isBrowser){console.log("PAS C\xD4T\xC9 NAVIGATEUR");return}console.log("=== DIAGNOSTIC TOKEN ==="),console.log("Service state:"),console.log("- isAuthenticated():",this.isAuthenticated()),console.log("- isSessionValid():",this.isSessionValid());let t=localStorage.getItem("token"),e=localStorage.getItem("user"),o=localStorage.getItem("authExpiry");if(console.log("LocalStorage:"),console.log("- token pr\xE9sent:",!!t),console.log("- token length:",t?.length||0),console.log("- user pr\xE9sent:",!!e),console.log("- expiry pr\xE9sent:",!!o),t&&(console.log("Token analysis:"),console.log("- Premier 30 chars:",t.substring(0,30)),console.log("- Format JWT (3 parties):",t.split(".").length===3),t.split(".").length===3))try{let s=t.split("."),i=JSON.parse(atob(s[0])),l=JSON.parse(atob(s[1]));if(console.log("- JWT header:",i),console.log("- JWT payload keys:",Object.keys(l)),l.exp){let m=new Date(l.exp*1e3),A=new Date;console.log("- Token expire le:",m.toISOString()),console.log("- Token expir\xE9:",A>m)}}catch(s){console.log("- ERREUR d\xE9codage JWT:",s)}let r=this.getToken();console.log("getToken() result:",r?"TOKEN RETOURN\xC9":"NULL"),console.log("Tokens identiques:",t===r),console.log("=== FIN DIAGNOSTIC ===")}getUserProfile(t){let e=this.getToken();if(!e)return console.error("\u274C Aucun token d'authentification trouv\xE9"),n(()=>new Error("Utilisateur non authentifi\xE9"));let o=new d({"Content-Type":"application/json",Authorization:`Bearer ${e}`});return this.http.get(`${this.API_URL}/utilisateurs/${t}`,{headers:o}).pipe(a(r=>{console.log("\u{1F4E8} R\xE9ponse brute r\xE9cup\xE9ration profil:",r)}),c(r=>{let s=this.decodeUnicodeInObject(r);return console.log("\u{1F4E8} R\xE9ponse d\xE9cod\xE9e r\xE9cup\xE9ration profil:",s),s}),u(r=>(console.error("\u274C Erreur r\xE9cup\xE9ration profil utilisateur:",r),r.error&&(r.error=this.decodeUnicodeInObject(r.error)),n(()=>new Error(r.error?.message||"Erreur serveur")))))}updateUserProfile(t,e){let o=this.getToken();if(!o)return console.error("\u274C Aucun token d'authentification trouv\xE9"),n(()=>new Error("Utilisateur non authentifi\xE9"));let r=new d({"Content-Type":"application/json",Authorization:`Bearer ${o}`});return console.log("\u{1F504} Mise \xE0 jour du profil utilisateur:",{userId:t,userData:e,url:`${this.API_URL}/utilisateurs/${t}`}),this.http.put(`${this.API_URL}/utilisateurs/${t}`,e,{headers:r}).pipe(a(s=>{console.log("\u{1F4E8} R\xE9ponse brute mise \xE0 jour profil:",s)}),c(s=>{let i=this.decodeUnicodeInObject(s);return console.log("\u{1F4E8} R\xE9ponse d\xE9cod\xE9e mise \xE0 jour profil:",i),i}),a(s=>{if(s.success&&s.data&&this.isBrowser){let i=this.getCurrentUser();if(i&&i.id_utilisateur===t){let l=p(p({},i),s.data);localStorage.setItem("user",JSON.stringify(l)),this.currentUserSubject.next(l),console.log("\u{1F464} Donn\xE9es utilisateur connect\xE9 mises \xE0 jour localement:",l)}else console.log("\u{1F464} Modification d'un autre utilisateur, pas de mise \xE0 jour locale")}}),u(s=>(console.error("\u274C Erreur mise \xE0 jour profil utilisateur:",s),s.error&&(s.error=this.decodeUnicodeInObject(s.error)),n(()=>new Error(s.error?.message||"Erreur serveur")))))}updateUserWithFormData(t,e){let o=this.getToken();if(!o)return console.error("\u274C Aucun token d'authentification trouv\xE9"),n(()=>new Error("Utilisateur non authentifi\xE9"));let r=new d({Authorization:`Bearer ${o}`});return console.log("\u{1F504} Mise \xE0 jour du profil utilisateur avec FormData:",{userId:t,url:`${this.API_URL}/utilisateurs/${t}/update`}),this.http.post(`${this.API_URL}/utilisateurs/${t}/update`,e,{headers:r}).pipe(a(s=>{console.log("\u{1F4E8} R\xE9ponse brute mise \xE0 jour profil (POST):",s)}),c(s=>{let i=this.decodeUnicodeInObject(s);return console.log("\u{1F4E8} R\xE9ponse d\xE9cod\xE9e mise \xE0 jour profil (POST):",i),i}),a(s=>{if(s.success&&s.data&&this.isBrowser){let i=this.getCurrentUser();if(i&&i.id_utilisateur===t){let l=p(p({},i),s.data);localStorage.setItem("user",JSON.stringify(l)),this.currentUserSubject.next(l),console.log("\u{1F464} Donn\xE9es utilisateur connect\xE9 mises \xE0 jour localement (POST):",l)}else console.log("\u{1F464} Modification d'un autre utilisateur, pas de mise \xE0 jour locale")}}),u(s=>(console.error("\u274C Erreur mise \xE0 jour profil utilisateur (POST):",s),s.error&&(s.error=this.decodeUnicodeInObject(s.error)),n(()=>new Error(s.error?.message||"Erreur serveur")))))}getAllUsers(){let t=this.getToken();if(!t)return console.error("\u274C Aucun token d'authentification trouv\xE9"),n(()=>new Error("Utilisateur non authentifi\xE9"));let e=new d({"Content-Type":"application/json",Authorization:`Bearer ${t}`});return this.http.get(`${this.API_URL}/utilisateurs`,{headers:e}).pipe(a(o=>{console.log("\u{1F4CB} R\xE9ponse brute r\xE9cup\xE9ration utilisateurs:",o)}),c(o=>{let r=this.decodeUnicodeInObject(o);return console.log("\u{1F4CB} R\xE9ponse d\xE9cod\xE9e r\xE9cup\xE9ration utilisateurs:",r),r.data}),u(o=>(console.error("\u274C Erreur r\xE9cup\xE9ration utilisateurs:",o),o.error&&(o.error=this.decodeUnicodeInObject(o.error)),n(()=>new Error(o.error?.message||"Erreur serveur")))))}createUser(t){let e=this.getToken();if(!e)return console.error("\u274C Aucun token d'authentification trouv\xE9"),n(()=>new Error("Utilisateur non authentifi\xE9"));let o=new d({"Content-Type":"application/json",Authorization:`Bearer ${e}`});return console.log("\u{1F504} Cr\xE9ation d'un nouvel utilisateur:",{userData:t,url:`${this.API_URL}/utilisateurs`}),this.http.post(`${this.API_URL}/utilisateurs`,t,{headers:o}).pipe(a(r=>{console.log("\u{1F4E8} R\xE9ponse brute cr\xE9ation utilisateur:",r)}),c(r=>{let s=this.decodeUnicodeInObject(r);return console.log("\u{1F4E8} R\xE9ponse d\xE9cod\xE9e cr\xE9ation utilisateur:",s),s}),u(r=>(console.error("\u274C Erreur cr\xE9ation utilisateur:",r),r.error&&(r.error=this.decodeUnicodeInObject(r.error)),n(()=>new Error(r.error?.message||"Erreur serveur")))))}createUserWithFiles(t){let e=this.getToken();if(!e)return console.error("\u274C Aucun token d'authentification trouv\xE9"),n(()=>new Error("Utilisateur non authentifi\xE9"));let o=new d({Authorization:`Bearer ${e}`});return console.log("\u{1F504} Cr\xE9ation d'un nouvel utilisateur avec fichiers:",{url:`${this.API_URL}/utilisateurs`}),this.http.post(`${this.API_URL}/utilisateurs`,t,{headers:o}).pipe(a(r=>{console.log("\u{1F4E8} R\xE9ponse brute cr\xE9ation utilisateur avec fichiers:",r)}),c(r=>{let s=this.decodeUnicodeInObject(r);return console.log("\u{1F4E8} R\xE9ponse d\xE9cod\xE9e cr\xE9ation utilisateur avec fichiers:",s),s}),u(r=>(console.error("\u274C Erreur cr\xE9ation utilisateur avec fichiers:",r),r.error&&(r.error=this.decodeUnicodeInObject(r.error)),n(()=>new Error(r.error?.message||"Erreur serveur")))))}checkEmailExists(t){let e=this.getToken();if(!e)return n(()=>new Error("Utilisateur non authentifi\xE9"));let o=new d({"Content-Type":"application/json",Authorization:`Bearer ${e}`});return this.http.get(`${this.API_URL}/check-email`,{headers:o,params:{email:t}}).pipe(c(r=>r.exists),u(r=>(console.error("\u274C Erreur v\xE9rification email:",r),U(!1))))}updateCurrentUser(t){this.isBrowser&&(localStorage.setItem("user",JSON.stringify(t)),this.currentUserSubject.next(t),console.log("\u{1F464} Utilisateur courant mis \xE0 jour:",t))}ngOnDestroy(){this.stopInactivityDetection()}static \u0275fac=function(e){return new(e||h)(b(I))};static \u0275prov=v({token:h,factory:h.\u0275fac,providedIn:"root"})};export{T as a};
