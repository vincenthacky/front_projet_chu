import './polyfills.server.mjs';
import{a as pe}from"./chunk-JMZOKYIL.mjs";import{a as re,b as oe,c as ae,d as se,e as me}from"./chunk-TRTTEYGM.mjs";import"./chunk-TPOFWVII.mjs";import{a as ie,b as te,c as ne}from"./chunk-3ECRGHAG.mjs";import{d as le,e as ue}from"./chunk-PY2DBSDC.mjs";import{a as M}from"./chunk-DVAA3UE3.mjs";import{c as Q,d as Y}from"./chunk-SDNTUH3C.mjs";import"./chunk-QBUOXPTD.mjs";import{a as Z}from"./chunk-ISHDDA2X.mjs";import{e as ee}from"./chunk-XPN6KDZ6.mjs";import{a as J,e as K}from"./chunk-BZBOIQCX.mjs";import{a as $,b as X,c as W}from"./chunk-UADZFZ3L.mjs";import{a as w,b as I,d as U,f as x}from"./chunk-F2M3OOMJ.mjs";import"./chunk-EKHRI43K.mjs";import"./chunk-TRLQKWDU.mjs";import"./chunk-RDD4RICX.mjs";import{B as H,d as O,e as l,g as G,h as q,n as R,o as k,q as L,r as P,w as j,z as B}from"./chunk-W7BGEYBY.mjs";import"./chunk-VTN35E7P.mjs";import"./chunk-DXOQ4KLL.mjs";import"./chunk-QQY3JPAX.mjs";import"./chunk-CHSZOI33.mjs";import"./chunk-2YQYLHAC.mjs";import"./chunk-LGFZWUQG.mjs";import"./chunk-HD2YVG74.mjs";import{e as D}from"./chunk-LI7RJ6PT.mjs";import"./chunk-UXVSRWVF.mjs";import{C as V,u as y,v as A}from"./chunk-SYXLOHCJ.mjs";import{Aa as S,Bb as a,Cc as T,Ob as n,Pb as r,Qb as s,Ub as N,_b as b,hb as u,ib as p,jc as m,lc as E,oa as C,sc as F,tc as _,xb as c,za as v}from"./chunk-OQNIVP4F.mjs";import{a as d,b as f}from"./chunk-5XUXGTUW.mjs";var de=()=>({xs:8,sm:16,md:24}),fe=()=>({xs:12,sm:16,md:24});function ze(o,i){o&1&&(s(0,"span",29),m(1," Nouvelle souscription "))}function ve(o,i){if(o&1&&s(0,"nz-option",30),o&2){let e=i.$implicit;a("nzValue",e.id_utilisateur)("nzLabel",e.nom+" "+e.prenom)}}function Se(o,i){if(o&1&&s(0,"nz-option",30),o&2){let e=i.$implicit;a("nzValue",e.id_terrain)("nzLabel",e.libelle+" - "+e.superficie+" m\xB2")}}function be(o,i){if(o&1&&s(0,"nz-option",30),o&2){let e=i.$implicit;a("nzValue",e.id_utilisateur)("nzLabel",e.nom+" "+e.prenom)}}function _e(o,i){if(o&1&&s(0,"nz-option",30),o&2){let e=i.$implicit;a("nzValue",e)("nzLabel",e)}}function ge(o,i){o&1&&s(0,"span",31)}var ce=class o{constructor(i,e,t,z,g,h){this.fb=i;this.terrainsService=e;this.souscriptionService=t;this.authService=z;this.message=g;this.router=h;this.initForm()}subscriptionForm;isSubmitting=!1;users=[];terrains=[];admins=[];statutOptions=["active","suspendu","annule"];ngOnInit(){if(!this.authService.isAdmin()){this.message.error("Seuls les administrateurs peuvent cr\xE9er des souscriptions."),this.router.navigate(["/"]);return}this.loadDropdownData(),this.prefillAdmin()}initForm(){let i=new Date;this.subscriptionForm=this.fb.group({id_utilisateur:[null,[l.required]],id_terrain:[null,[l.required]],id_admin:[null,[l.required]],nombre_terrains:[1,[l.required,l.min(1)]],montant_mensuel:[0,[l.required,l.min(0)]],nombre_mensualites:[64,[l.required,l.min(1)]],date_souscription:[new Date,[l.required]],date_debut_paiement:[i,[l.required]],statut_souscription:["active",[l.required]],notes_admin:[""]})}loadDropdownData(){this.authService.getAllUsers().subscribe({next:e=>{this.users=e.map(t=>f(d({},t),{statut_utilisateur:this.normalizeStatutUtilisateur(t.statut_utilisateur)})).filter(t=>t.type!=="superAdmin"&&t.type!=="admin"),console.log("\u{1F465} Utilisateurs non-admin charg\xE9s:",this.users)},error:()=>this.message.error("Erreur lors du chargement des utilisateurs.")}),this.terrainsService.getAllTerrains().subscribe({next:e=>{this.terrains=e.data.filter(t=>t.statut_terrain==="disponible"),console.log("\u{1F30D} Terrains bruts r\xE9cup\xE9r\xE9s:",e.data),console.log("\u{1F30D} Terrains disponibles charg\xE9s:",this.terrains)},error:()=>this.message.error("Erreur lors du chargement des terrains.")});let i=this.authService.getCurrentUser();i&&this.authService.isAdmin()?(this.admins=[f(d({},i),{statut_utilisateur:this.normalizeStatutUtilisateur(i.statut_utilisateur)})],console.log("\u{1F464} Admin connect\xE9 charg\xE9:",this.admins)):(this.admins=[],console.warn("\u26A0\uFE0F Aucun administrateur connect\xE9 ou utilisateur non-admin"),this.message.error("Aucun administrateur connect\xE9 d\xE9tect\xE9."))}normalizeStatutUtilisateur(i){return["actif","suspendu","inactif"].includes(i)?i:"inactif"}prefillAdmin(){let i=this.authService.getCurrentUser();console.log("\u{1F50D} Pr\xE9-remplissage admin - Utilisateur connect\xE9:",i),i&&this.authService.isAdmin()?(this.subscriptionForm.patchValue({id_admin:i.id_utilisateur}),console.log("\u2705 Champ id_admin pr\xE9-rempli avec:",i.id_utilisateur)):console.warn("\u26A0\uFE0F Aucun admin connect\xE9 ou utilisateur non-admin")}onTerrainChange(i){let e=this.terrains.find(t=>t.id_terrain===i);e&&e.montant_mensuel&&(this.subscriptionForm.patchValue({montant_mensuel:parseFloat(e.montant_mensuel)}),console.log("Montant mensuel mis \xE0 jour:",e.montant_mensuel))}onSubmit(){if(this.subscriptionForm.invalid){this.message.error("Veuillez remplir tous les champs requis correctement."),this.markFormGroupTouched();return}this.isSubmitting=!0;let i=f(d({},this.subscriptionForm.value),{montant_mensuel:this.subscriptionForm.value.montant_mensuel.toString()});this.souscriptionService.createSouscription(i).subscribe({next:e=>{this.isSubmitting=!1,this.message.success("Souscription cr\xE9\xE9e avec succ\xE8s !");let t=new Date;this.subscriptionForm.reset({id_utilisateur:null,id_terrain:null,id_admin:this.authService.getCurrentUser()?.id_utilisateur||null,nombre_terrains:1,montant_mensuel:0,nombre_mensualites:64,date_souscription:new Date,date_debut_paiement:t,statut_souscription:"active",notes_admin:""}),this.router.navigate(["/dashboard/admin/details/souscription-admin"])},error:e=>{this.isSubmitting=!1,this.message.error(e.message||"Erreur lors de la cr\xE9ation de la souscription.")}})}markFormGroupTouched(){Object.values(this.subscriptionForm.controls).forEach(i=>{i.markAsTouched(),i.updateValueAndValidity()})}static \u0275fac=function(e){return new(e||o)(p(B),p(pe),p(Z),p(M),p(ee),p(D))};static \u0275cmp=C({type:o,selectors:[["app-create-subscription-admin"]],standalone:!0,features:[F],decls:75,vars:15,consts:[["subscriptionTitle",""],["nz-row","",3,"nzGutter"],["nz-col","","nzSpan","24"],["nzTitle","Cr\xE9er une nouvelle souscription",1,"subscription-card",3,"nzBordered"],["nz-form","",3,"ngSubmit","formGroup"],["nz-col","","nzXs","24","nzSm","12"],["nzRequired",""],["nzErrorTip","Veuillez s\xE9lectionner un planteur"],["formControlName","id_utilisateur","nzPlaceHolder","S\xE9lectionner un utilisateur"],[3,"nzValue","nzLabel",4,"ngFor","ngForOf"],["nzErrorTip","Veuillez s\xE9lectionner un terrain"],["formControlName","id_terrain","nzPlaceHolder","S\xE9lectionner un terrain",3,"ngModelChange"],["nzFor","id_admin"],["formControlName","id_admin","nzPlaceHolder","S\xE9lectionner un administrateur"],["nzErrorTip","Veuillez entrer un nombre valide (minimum 1)"],["nz-input","","formControlName","nombre_terrains","type","number","min","1","readonly","",2,"background-color","#f5f5f5","cursor","not-allowed"],["nzErrorTip","Veuillez entrer un montant valide"],["nz-input","","formControlName","montant_mensuel","type","number","step","0.01","min","0","readonly","",2,"background-color","#f5f5f5","cursor","not-allowed"],["nz-input","","formControlName","nombre_mensualites","type","number","min","1","readonly","",2,"background-color","#f5f5f5","cursor","not-allowed"],["nzErrorTip","Veuillez s\xE9lectionner une date"],["formControlName","date_souscription","nzFormat","yyyy-MM-dd HH:mm:ss",3,"nzShowTime"],["formControlName","date_debut_paiement","nzFormat","yyyy-MM-dd"],["nzErrorTip","Veuillez s\xE9lectionner un statut"],["formControlName","statut_souscription","nzPlaceHolder","S\xE9lectionner un statut"],["nz-col","","nzXs","24"],["nz-input","","formControlName","notes_admin","rows","4"],[1,"form-actions"],["nz-button","","nzType","primary","type","submit",3,"nzLoading","disabled"],["nz-icon","","nzType","save","nzTheme","outline",4,"ngIf"],["nz-icon","","nzType","form","nzTheme","outline"],[3,"nzValue","nzLabel"],["nz-icon","","nzType","save","nzTheme","outline"]],template:function(e,t){if(e&1){let z=N();n(0,"div",1)(1,"div",2)(2,"nz-card",3),c(3,ze,2,0,"ng-template",null,0,T),n(5,"form",4),b("ngSubmit",function(){return v(z),S(t.onSubmit())}),n(6,"div",1)(7,"div",5)(8,"nz-form-item")(9,"nz-form-label",6),m(10,"Utilisateur"),r(),n(11,"nz-form-control",7)(12,"nz-select",8),c(13,ve,1,2,"nz-option",9),r()()()(),n(14,"div",5)(15,"nz-form-item")(16,"nz-form-label",6),m(17,"Terrain"),r(),n(18,"nz-form-control",10)(19,"nz-select",11),b("ngModelChange",function(h){return v(z),S(t.onTerrainChange(h))}),c(20,Se,1,2,"nz-option",9),r()()()(),n(21,"div",5)(22,"nz-form-item")(23,"nz-form-label",12),m(24,"Administrateur"),r(),n(25,"nz-form-control")(26,"nz-select",13),c(27,be,1,2,"nz-option",9),r()()()(),n(28,"div",5)(29,"nz-form-item")(30,"nz-form-label",6),m(31,"Nombre de terrains"),r(),n(32,"nz-form-control",14),s(33,"input",15),r()()(),n(34,"div",5)(35,"nz-form-item")(36,"nz-form-label",6),m(37,"Montant mensuel (CFA)"),r(),n(38,"nz-form-control",16),s(39,"input",17),r()()(),n(40,"div",5)(41,"nz-form-item")(42,"nz-form-label",6),m(43,"Nombre de mensualit\xE9s"),r(),n(44,"nz-form-control",14),s(45,"input",18),r()()(),n(46,"div",5)(47,"nz-form-item")(48,"nz-form-label",6),m(49,"Date de souscription"),r(),n(50,"nz-form-control",19),s(51,"nz-date-picker",20),r()()(),n(52,"div",5)(53,"nz-form-item")(54,"nz-form-label",6),m(55,"Date de d\xE9but de paiement"),r(),n(56,"nz-form-control",19),s(57,"nz-date-picker",21),r()()(),n(58,"div",5)(59,"nz-form-item")(60,"nz-form-label",6),m(61,"Statut"),r(),n(62,"nz-form-control",22)(63,"nz-select",23),c(64,_e,1,2,"nz-option",9),r()()()(),n(65,"div",24)(66,"nz-form-item")(67,"nz-form-label"),m(68,"Notes de l'administrateur"),r(),n(69,"nz-form-control"),s(70,"textarea",25),r()()()(),n(71,"div",26)(72,"button",27),c(73,ge,1,0,"span",28),m(74),r()()()()()()}e&2&&(a("nzGutter",_(13,de)),u(2),a("nzBordered",!1),u(3),a("formGroup",t.subscriptionForm),u(),a("nzGutter",_(14,fe)),u(7),a("ngForOf",t.users),u(7),a("ngForOf",t.terrains),u(7),a("ngForOf",t.admins),u(24),a("nzShowTime",!0),u(13),a("ngForOf",t.statutOptions),u(8),a("nzLoading",t.isSubmitting)("disabled",t.subscriptionForm.invalid),u(),a("ngIf",!t.isSubmitting),u(),E(" ",t.isSubmitting?"Cr\xE9ation...":"Cr\xE9er la souscription"," "))},dependencies:[V,y,A,H,R,O,k,G,q,j,L,P,me,te,ie,oe,re,se,ae,K,J,x,U,w,I,W,$,X,Y,Q,ne,ue,le]})};export{ce as CreateSubscriptionAdminComponent};
